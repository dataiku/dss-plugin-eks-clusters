name: Build and create pre-release for the EKS cluster plugin

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Commit hash or branch to release (optional, defaults to master)'
        required: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{ inputs.target || 'master' }}

    - name: Retrieve plugin info
      id: plugin_info
      run: |
        id=$(jq -r '.id' plugin.json)
        version=$(jq -r '.version' plugin.json)
        echo "Creating release for plugin '$id' and version '$version'"
        echo "::set-output name=id::$id"
        echo "::set-output name=version::$version"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y make

    - name: Compile plugin into archive
      run: make plugin

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v${{ steps.plugin_info.outputs.version }}"
        release_name: "v${{ steps.plugin_info.outputs.version }}"
        commitish: ${{ inputs.target || 'master' }}
        body: |
          This is a pre-release for version of the DSS EKS plugin ${{ steps.plugin_info.outputs.id }} ${{ steps.plugin_info.outputs.version }}.
          Please add the release notes from the changelog in this description prior to release.
        draft: true # Ensures the tag is not created with the action, but only when manually publishing
        prerelease: true

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/dss-plugin-${{ steps.plugin_info.outputs.id }}-${{ steps.plugin_info.outputs.version }}.zip
        asset_name: "dss-plugin-${{ steps.plugin_info.outputs.id }}-${{ steps.plugin_info.outputs.version }}"
        asset_content_type: application/zip

    - name: Clean up release assets
      run: make dist-clean
